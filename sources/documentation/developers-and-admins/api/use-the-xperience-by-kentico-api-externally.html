<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Use the Xperience by Kentico API externally</title>
</head>
<body>
<p>This page describes how to configure external .NET applications to work with the Xperience API. Using Xperience functionality externally is suitable for scenarios such as:</p>
<ul>
<li>Separate applications integrated with your main Xperience website (e.g., for the purposes of data synchronization with third party applications)</li>
<li>Custom websites or applications that use Xperience as a content repository</li>
</ul>

<div>

</div>
<div>
<p><strong>Limitations of</strong> <strong>SaaS deployments</strong></p>
<p>You cannot connect to Xperience applications <a href="/documentation/developers-and-admins/deployment/deploy-to-the-saas-environment">deployed to the SaaS environment</a> from external .NET applications.</p>
</div>

<p>To enable Xperience by Kentico API in your external .NET application:</p>
<ol type="1">
<li><a href="#connect-to-the-xperience-database">Connect to the Xperience database</a></li>
<li><a href="#add-the-xperience-api-nuget-packages">Add the Xperience API NuGet packages</a></li>
<li><a href="#initialize-the-xperience-application">Initialize the Xperience application</a></li>
</ol>
<h2 id="connect-to-the-xperience-database">Connect to the Xperience database</h2>
<p>To be able to access the Xperience database, you need to specify the appropriate connection string in your application’s configuration file.</p>

<div>

</div>
<div>
<p>If you are storing application configuration in files on the file system, make sure their <strong>Copy to output directory</strong> is set to <strong>Always</strong> in the <em>.csproj</em>.</p>
<div>
<div>
<div>
<div>
<span>XML</span>
</div>
<strong>Example</strong>
</div>
<div>
<button>
<span></span><span></span> <span>Copy</span>
</button>
</div>
</div>
<div>
<pre><code>
&lt;ItemGroup&gt;
    &lt;None Update="appsettings.json"&gt;
      &lt;CopyToOutputDirectory&gt;Always&lt;/CopyToOutputDirectory&gt;
    &lt;/None&gt;
&lt;/ItemGroup&gt;
</code></pre>
</div>
</div>
</div>

<p>Add the connection string into the <em>ConnectionStrings</em> object under the <strong>CMSConnectionString</strong> key:</p>

<div>
<div>
<div>
<span>JSON</span>
</div>
<strong></strong>
</div>
<div>
<button>
<span></span><span></span> <span>Copy</span>
</button>
</div>
</div>
<div>
<pre><code>

"ConnectionStrings": {
    "CMSConnectionString": "Persist Security Info=False;database=Xperience;server=myserver;user id=username;password=mypassword;Current Language=English;Connection Timeout=120;"
 }

</code></pre>
</div>


<div>

</div>
<div>
<p><strong>Tip</strong>: We recommend copying the exact connection string from the configuration file of your Xperience application.</p>
</div>

<h2 id="add-the-xperience-api-nuget-packages">Add the Xperience API NuGet packages</h2>
<p>Before you can use Xperience functionality in your application, you need to add the Xperience API NuGet packages:</p>
<ol type="1">
<li>Right-click your application’s project in the Visual Studio <strong>Solution Explorer</strong> and select <strong>Manage NuGet Packages</strong>.</li>
<li>Search for the <strong>Kentico.Xperience.Core</strong> package.</li>
<li>Install the <em>Kentico.Xperience.Core</em> version that matches the version of the connected Xperience database.</li>
</ol>

<div>

</div>
<div>
<p><strong>Maintaining Kentico.Xperience.Core package version</strong></p>
<p>If you <a href="/documentation/developers-and-admins/installation/update-xperience-by-kentico-projects">update</a> the related Xperience project and its database to a newer version, you also need to update the NuGet packages to a matching version in your external application.</p>
</div>

<h2 id="initialize-the-xperience-application">Initialize the Xperience application</h2>
<p>You need to initialize the system before making calls to its API from an external project.</p>
<h3 id="web-applications">Web applications</h3>
<p>Call the following code on application startup. The initialization sequence is performed only once and skipped during subsequent calls.</p>

<div>
<div>
<div>
<span>C#</span>
</div>
<strong>Program.cs - web app</strong>
</div>
<div>
<button>
<span></span><span></span> <span>Copy</span>
</button>
</div>
</div>
<div>
<pre><code>
using CMS.Core;
using CMS.DataEngine;
using Microsoft.AspNetCore.Builder;

// ...

// Ensures a preconfigured environment (DI, configuration providers) for .NET web apps
var builder = WebApplication.CreateBuilder(args);

// Preinitializes Xperience by Kentico without building a custom DI container
CMSApplication.PreInit(false);
// Merges Xperience services with the application's service collection
Service.MergeDescriptors(builder.Services);

WebApplication app = builder.Build();

// Tells Xperience to use this app's service container for service resolution
Service.SetProvider(app.Services);

// Initializes Xperience APIs and database for use in the app
CMSApplication.Init();
</code></pre>
</div>

<h3 id="non-web-applications-console-applications-etc.">Non-web applications (Console applications, etc.)</h3>
<ol type="1">
<li><p>Edit your application’s <code>Main</code> method.</p></li>
<li>
<p>Call the following code on application startup:</p>

<div>
<div>
<div>
<span>C#</span>
</div>
<strong>Program.cs - console app</strong>
</div>
<div>
<button>
<span></span><span></span> <span>Copy</span>
</button>
</div>
</div>
<div>
<pre><code>
 using CMS.Core;
 using CMS.DataEngine;
 using Microsoft.Extensions.Hosting;

 // ...

 // Ensures a preconfigured environment (DI, configuration providers) for .NET console apps
 var builder = Host.CreateApplicationBuilder(args);

 // Preinitializes Xperience by Kentico without building a custom DI container
 CMSApplication.PreInit(false);
 // Merges Xperience services with the application's service collection
 Service.MergeDescriptors(builder.Services);

 var app = builder.Build();

 // Tells Xperience to use this app's service container for service resolution
 Service.SetProvider(app.Services);

 // Initializes Xperience APIs and database for use in the app
 CMSApplication.Init();
 </code></pre>
</div>
</li>
</ol>
<p>You can now use the Xperience API in your external application. The API allows you to perform any action available in the standard administration interface.</p>

<div>

</div>
<div>
<p><strong>Custom code that requires discovery</strong></p>
<p>For external projects that compile into a different output type than a DLL assembly (console applications, etc.), do <strong>NOT</strong> directly add any custom classes that need to be detected during the API initialization. This includes classes registered using attributes, such as <a href="/documentation/developers-and-admins/customization/run-code-on-application-startup">custom module classes</a>, custom implementations of <a href="/documentation/developers-and-admins/customization/decorate-system-services">services</a> or <a href="/documentation/developers-and-admins/customization/customize-system-providers">providers</a>, etc. The system is only able to discover such code within assemblies.</p>
<p>Instead, add the code into a <em>Class Library</em> project with the <code>AssemblyDiscoverable</code> attribute and reference the assembly from your project. See <a href="/documentation/developers-and-admins/customization/integrate-custom-code">Integrate custom code</a>.</p>
</div>

<h2 id="additional-configuration-and-tips">Additional configuration and tips</h2>
<h3 id="share-project-files-with-the-xperience-application">Share project files with the Xperience application</h3>
<p>If you need to call API that works with a specific folder in the Xperience project, <a href="/documentation/developers-and-admins/api/files-api-and-cms-io/file-system-providers">map the physical path</a> used by the Xperience API in your external application to a specific Xperience project.</p>
<ol type="1">
<li>Open the external application in Visual Studio.</li>
<li>Create a <a href="/documentation/developers-and-admins/customization/run-code-on-application-startup">custom module class</a>. The module’s initialization code runs when you <a href="#initialize-the-xperience-application">initialize the Xperience application</a>.</li>
<li>Override the module’s <code>OnInit</code> method and perform the required <code>StorageProvider</code> modifications:
<ol type="1">
<li>Create a new instance of the <code>StorageProvider</code> class (the <code>isSharedStorage</code> parameter of the <code>CreateFileSystemStorageProvider</code> method must be <code>true</code>).</li>
<li>Set the target directory via the provider’s <code>CustomRootPath</code> property. The provider creates new files and folders relative to the given root.</li>
<li>Map the folder used by your external application. For example, if an external application imports <a href="/documentation/business-users/content-hub/content-item-assets">content item assets</a>, map the <strong>~/assets</strong> folder.</li>
</ol>
</li>
</ol>

<div>
<div>
<div>
<span>C#</span>
</div>
<strong>Example</strong>
</div>
<div>
<button>
<span></span><span></span> <span>Copy</span>
</button>
</div>
</div>
<div>
<pre><code>

public class CustomFileSystemMappingModule : Module
{
    // Module class constructor, the system registers the module under the name "CustomFSMapping"
    public CustomFileSystemMappingModule ()
        : base("CustomFSMapping")
    {
    }

    // Contains initialization code that is executed when the application starts
    protected override void OnInit()
    {
        base.OnInit();

        // Creates a new StorageProvider instance for regular file systems (NTFS, VFAT)
        var sharedAssetsProvider = StorageProvider.CreateFileSystemStorageProvider(isSharedStorage: true);

        // Specifies the root directory of the target Xperience project. 
        // The provider creates the relative path of the mapped folders within the given directory.
        sharedMediaProvider.CustomRootPath = @"C:\inetpub\wwwroot\Xperience\";

        // Maps the ~/assets directory from your external application's folder to the provider
        StorageHelper.MapStoragePath("~/assets/", sharedMediaProvider);
    }
}

</code></pre>
</div>

<h3 id="work-with-the-user-context">Work with the user context</h3>
<p>When working with the Xperience API in an external application, the default Xperience user context is not available.</p>
<p>To use API that relies on the context of a specific user, enclose the code into a <code>using</code> statement with a declared <code>CMSActionContext</code> instance and the appropriate <code>UserInfo</code> object as a parameter.</p>

<div>
<div>
<div>
<span>C#</span>
</div>
<strong>Example</strong>
</div>
<div>
<button>
<span></span><span></span> <span>Copy</span>
</button>
</div>
</div>
<div>
<pre><code>
using Microsoft.Extensions.Logging;

using CMS.Base;
using CMS.Core;
using CMS.DataEngine;
using CMS.Membership;

// ...

// Instances of  services obtained using dependency injection
private readonly ILogger&lt;ExternalAppClass&gt; logger;
private readonly IUserInfoProvider userInfoProvider;

// ...

// Gets an object representing a specific Xperience user
UserInfo user = userInfoProvider.Get("Andy");

// Sets the context of the user
using (new CMSActionContext(user))
{
    // Logs a warning event into the Xperience event log, with "Andy" as the user who caused the event
    logger.LogWarning(new EventId(0, "Event_Code"), "Detailed event description.");
}
</code></pre>
</div>


</body>
</html>
